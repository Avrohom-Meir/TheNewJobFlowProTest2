{"version":3,"sources":["../src/db.ts","../src/tenant.ts"],"sourcesContent":["import { drizzle } from 'drizzle-orm/postgres-js'\nimport postgres from 'postgres'\nimport * as masterSchema from '@jobflow/db-master'\nimport * as tenantSchema from '@jobflow/db-tenant'\n\nconst masterClient = postgres(process.env.MASTER_DB_URL!)\nexport const masterDb = drizzle(masterClient, { schema: masterSchema })\n\nexport function getTenantDb(tenantDbUrl: string) {\n  const client = postgres(tenantDbUrl)\n  return drizzle(client, { schema: tenantSchema })\n}","import { masterDb } from './db'\nimport { eq } from 'drizzle-orm'\nimport { tenants, tenantDatabases } from '@jobflow/db-master'\n\nexport async function getTenantBySubdomain(subdomain: string) {\n  const result = await masterDb\n    .select()\n    .from(tenants)\n    .where(eq(tenants.subdomain, subdomain))\n    .limit(1)\n\n  if (result.length === 0) return null\n\n  const tenant = result[0]\n\n  const dbResult = await masterDb\n    .select()\n    .from(tenantDatabases)\n    .where(eq(tenantDatabases.tenantId, tenant.id))\n    .limit(1)\n\n  if (dbResult.length === 0) return null\n\n  return {\n    ...tenant,\n    dbUrl: dbResult[0].connectionSecretRef, // assuming it's the url\n  }\n}"],"mappings":";AAAA,SAAS,eAAe;AACxB,OAAO,cAAc;AACrB,YAAY,kBAAkB;AAC9B,YAAY,kBAAkB;AAE9B,IAAM,eAAe,SAAS,QAAQ,IAAI,aAAc;AACjD,IAAM,WAAW,QAAQ,cAAc,EAAE,QAAQ,aAAa,CAAC;AAE/D,SAAS,YAAY,aAAqB;AAC/C,QAAM,SAAS,SAAS,WAAW;AACnC,SAAO,QAAQ,QAAQ,EAAE,QAAQ,aAAa,CAAC;AACjD;;;ACVA,SAAS,UAAU;AACnB,SAAS,SAAS,uBAAuB;AAEzC,eAAsB,qBAAqB,WAAmB;AAC5D,QAAM,SAAS,MAAM,SAClB,OAAO,EACP,KAAK,OAAO,EACZ,MAAM,GAAG,QAAQ,WAAW,SAAS,CAAC,EACtC,MAAM,CAAC;AAEV,MAAI,OAAO,WAAW;AAAG,WAAO;AAEhC,QAAM,SAAS,OAAO,CAAC;AAEvB,QAAM,WAAW,MAAM,SACpB,OAAO,EACP,KAAK,eAAe,EACpB,MAAM,GAAG,gBAAgB,UAAU,OAAO,EAAE,CAAC,EAC7C,MAAM,CAAC;AAEV,MAAI,SAAS,WAAW;AAAG,WAAO;AAElC,SAAO;AAAA,IACL,GAAG;AAAA,IACH,OAAO,SAAS,CAAC,EAAE;AAAA;AAAA,EACrB;AACF;","names":[]}